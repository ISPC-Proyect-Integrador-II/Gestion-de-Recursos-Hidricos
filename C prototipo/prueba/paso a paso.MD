
- **Informe 1:** Explica c√≥mo trabaja el programa paso por paso, desde la inicializaci√≥n hasta la ejecuci√≥n en el ESP32.  
- **Informe 2:** Explica c√≥mo se pueden hacer ediciones para agregar mejoras al sistema.  

---

# üìù **Informe 1: Funcionamiento del Programa Paso a Paso**  

## üìå **1. Inicio y Configuraci√≥n Inicial**  

Cuando el ESP32 se inicia, se ejecuta la funci√≥n `setup()`. Esta secci√≥n se encarga de:  

1. **Inicializar la comunicaci√≥n serial** para debug.  
2. **Inicializar la pantalla TFT** para la interfaz gr√°fica.  
3. **Inicializar sensores** (DHT11, DS18B20, nivel de agua, caudal√≠metro, pH, etc.).  
4. **Inicializar control de automatizaci√≥n** (bomba de agua, luces, alarmas).  
5. **Conectar a WiFi** y, si es necesario, a MQTT para recibir y enviar datos.  
6. **Activar m√≥dulos de comunicaci√≥n** (BLE Mesh, LoRa Mesh).  
7. **Cargar recetas desde EEPROM** para aplicar par√°metros de cultivo preconfigurados.  
8. **Definir si el nodo act√∫a como transmisor o receptor** (esto se configura en `transmisor.h` y `receptor.h`).  
9. **Inicializar RTC** para manejar fecha y hora correctamente.  

Todo esto ocurre una sola vez al arrancar el ESP32.  

## üìå **2. Ejecuci√≥n C√≠clica en `loop()`**  

Despu√©s de la inicializaci√≥n, el programa entra en un ciclo de ejecuci√≥n infinita dentro de `loop()`. En cada ciclo se realizan varias tareas:  

‚úî **Actualizar pantalla TFT** con los √∫ltimos datos obtenidos.  
‚úî **Manejar la entrada de botones** para navegar en los men√∫s.  
‚úî **Mantener activa la conexi√≥n WiFi y MQTT**.  
‚úî **Leer sensores** (temperatura, pH, nivel de agua, flujo, luz, gas, corriente).  
‚úî **Ejecutar control autom√°tico** seg√∫n los umbrales configurados:  
   - Si el **nivel de agua es bajo**, activa la bomba.  
   - Si la **luz es insuficiente**, activa la iluminaci√≥n artificial.  
   - Si el **pH est√° fuera de rango**, env√≠a una alerta.  
‚úî **Verificar alarmas** y enviar notificaciones si se detectan valores peligrosos.  
‚úî **Transmitir datos** si el nodo es transmisor.  
‚úî **Recibir datos y ejecutar comandos** si el nodo es receptor.  
‚úî **Actualizar hora con RTC** y sincronizar si hay conexi√≥n MQTT.  

Este ciclo se repite indefinidamente, asegurando que el sistema siempre est√© monitoreando y actuando seg√∫n los datos que recibe.  

## üìå **3. Modos de Operaci√≥n**  

El programa admite dos modos de operaci√≥n:  

1Ô∏è‚É£ **Modo Transmisor:** Recoge datos de sensores y los env√≠a v√≠a MQTT, LoRa o BLE.  
2Ô∏è‚É£ **Modo Receptor:** Procesa los datos recibidos y ejecuta acciones en respuesta (por ejemplo, activando la iluminaci√≥n o modificando la frecuencia de riego).  

## üìå **4. Men√∫s y Configuraci√≥n desde Pantalla**  

El usuario puede usar los botones f√≠sicos para:  

‚úî **Activar o desactivar sensores** desde el men√∫ de configuraci√≥n.  
‚úî **Seleccionar una receta de cultivo** con par√°metros espec√≠ficos.  
‚úî **Sincronizar WiFi** desde una lista de redes disponibles.  
‚úî **Visualizar alertas y estados del sistema**.  

## üìå **5. Comunicaci√≥n entre Dispositivos**  

El ESP32 puede comunicarse de varias formas:  
‚úî **WiFi + MQTT:** Para enviar datos a la nube o recibir comandos remotos.  
‚úî **BLE Mesh:** Para conectarse con otros nodos ESP32 cercanos.  
‚úî **LoRa Mesh:** Para comunicaci√≥n a larga distancia sin WiFi.  

Si el sistema detecta una desconexi√≥n en WiFi o MQTT, intentar√° reconectar autom√°ticamente.  

---

# üõ†Ô∏è **Informe 2: C√≥mo Hacer Ediciones y Agregar Mejoras**  

El proyecto est√° dise√±ado para ser **modular**, lo que significa que cada funcionalidad est√° separada en su propio archivo. Esto facilita la edici√≥n y la ampliaci√≥n del sistema sin afectar otros m√≥dulos.  

## üìå **1. C√≥mo Agregar un Nuevo Sensor**  

Para agregar un nuevo sensor:  

1Ô∏è‚É£ **Define su pin en `sensores.h`**, por ejemplo:  
```cpp
#define SENSOR_CO2_PIN 37
```
2Ô∏è‚É£ **Crea una funci√≥n para leer el sensor en `sensores.cpp`**, ejemplo:  
```cpp
float leerCO2() {
    return analogRead(SENSOR_CO2_PIN) * 0.1;
}
```
3Ô∏è‚É£ **Actualiza `loop()` en `Hidroponia.ino`** para leer el nuevo sensor peri√≥dicamente:  
```cpp
float co2 = leerCO2();
Serial.println("CO2: " + String(co2));
```
4Ô∏è‚É£ **Env√≠a los datos por MQTT** en `transmisor.cpp`:  
```cpp
String datos = "{\"CO2\":" + String(co2) + "}";
client.publish("hidroponia/datos", datos.c_str());
```

---

## üìå **2. C√≥mo Agregar un Nuevo Men√∫ en Pantalla**  

Si necesitas agregar un nuevo men√∫, por ejemplo, para estad√≠sticas avanzadas:  

1Ô∏è‚É£ **Crea una nueva pantalla en `menu.h`**, por ejemplo:  
```cpp
void mostrarMenuEstadisticas();
```
2Ô∏è‚É£ **Define la l√≥gica del men√∫ en `menu.cpp`**, ejemplo:  
```cpp
void mostrarMenuEstadisticas() {
    tft.fillScreen(ST7735_BLACK);
    tft.setCursor(10, 10);
    tft.setTextSize(1);
    tft.setTextColor(ST7735_WHITE);
    tft.println("[ ESTAD√çSTICAS ]");
    tft.println("Promedio de pH: " + String(promedioPH));
    tft.println("Flujo medio: " + String(promedioFlujoAgua));
}
```
3Ô∏è‚É£ **Agrega la opci√≥n en el men√∫ principal (`menu.cpp`)**:  
```cpp
tft.println(opcionMenu == 4 ? "> Estad√≠sticas" : "  Estad√≠sticas");
```
4Ô∏è‚É£ **Maneja la selecci√≥n del nuevo men√∫** en `menu.cpp`:  
```cpp
if (opcionMenu == 4) mostrarMenuEstadisticas();
```

---

## üìå **3. C√≥mo Agregar una Nueva Funci√≥n Autom√°tica**  

Si necesitas agregar una automatizaci√≥n nueva, como el control de nutrientes basado en el pH:  

1Ô∏è‚É£ **Agrega la l√≥gica en `control.h`**, por ejemplo:  
```cpp
void ajustarNutrientes();
```
2Ô∏è‚É£ **Define la funci√≥n en `control.cpp`**, ejemplo:  
```cpp
void ajustarNutrientes() {
    if (phValor < 5.8) {
        Serial.println("Agregando nutrientes alcalinos.");
    } else if (phValor > 7.2) {
        Serial.println("Agregando nutrientes √°cidos.");
    } else {
        Serial.println("pH dentro del rango √≥ptimo.");
    }
}
```
3Ô∏è‚É£ **Llama a la funci√≥n desde `loop()` en `Hidroponia.ino`**:  
```cpp
ajustarNutrientes();
```

---

## üìå **4. C√≥mo Modificar el Sistema de Comunicaci√≥n**  

Si deseas enviar datos no solo por MQTT, sino tambi√©n por LoRa y BLE simult√°neamente:  

1Ô∏è‚É£ **Modifica `transmisor.cpp`** para incluir ambos env√≠os:  
```cpp
void enviarDatos() {
    if (!esNodoTransmisor) return;
    
    String datos = "{\"tempAgua\":" + String(temperaturaAgua) + "}";

    client.publish("hidroponia/datos", datos.c_str());  // Enviar por MQTT
    enviarDatosLoRa(datos);  // Enviar por LoRa
    enviarDatosBLE(datos);  // Enviar por BLE
}
```
2Ô∏è‚É£ **Aseg√∫rate de que las funciones `enviarDatosLoRa()` y `enviarDatosBLE()` est√©n activas**.  

---
